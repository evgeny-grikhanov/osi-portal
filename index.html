<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Документы Nest One</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: #fff; font-family: sans-serif; }
        #header { background: #000; padding: 15px; text-align: center; border-bottom: 2px solid #d4af37; position: sticky; top: 0; z-index: 10; }
        #viewer { display: flex; flex-direction: column; align-items: center; padding: 10px; }
        canvas { max-width: 100%; height: auto; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: #fff; }
        #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #d4af37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="header">ЗАЩИЩЕННЫЙ ПРОСМОТР</div>
<div id="loader"><div class="spinner"></div><div id="status">Загрузка...</div></div>
<div id="viewer"></div>

<script>
    // 1. ВСТАВЬ СЮДА СВОЮ НОВУЮ ССЫЛКУ ПОСЛЕ ДЕПЛОЯ
    const API = 'https://script.google.com/macros/s/AKfycbwh9dwQE_8lM3ZYbEEVyo4DwUC3RFdcXTi_tdBhmIjt237exEIiQFzW0uS11OQfzyDW/exec';
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const uid = params.get('id');

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    async function load() {
        if (!fid || !uid) { document.getElementById('status').innerText = 'Ошибка ссылки'; return; }

        try {
            // Шаг 1: Водяной знак
            const wmRes = await fetch(`${API}?action=getWatermark&id=${uid}`);
            const wmData = await wmRes.json();
            
            // Шаг 2: PDF
            const pdfRes = await fetch(`${API}?action=getPdf&fid=${fid}`);
            const pdfData = await pdfRes.json();

            if (pdfData.success) {
                render(pdfData.base64, wmData.watermark);
            }
        } catch (e) { document.getElementById('status').innerText = 'Ошибка доступа'; }
    }

    async function render(base64, text) {
        const pdf = await pdfjsLib.getDocument({ data: atob(base64) }).promise;
        document.getElementById('loader').style.display = 'none';

        for (let n = 1; n <= pdf.numPages; n++) {
            const page = await pdf.getPage(n);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            drawWM(canvas, text);
            document.getElementById('viewer').appendChild(canvas);
        }
    }

    function drawWM(canvas, text) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;

        ctx.save();
        ctx.font = `bold ${Math.round(w / 35)}px Arial`;
        ctx.fillStyle = "rgba(255, 0, 0, 0.12)"; // Бледно-красный
        ctx.textAlign = "center";
        
        ctx.translate(w / 2, h / 2);
        ctx.rotate(-Math.PI / 4);

        const stepY = h / 25; // Расстояние между 25+ строками
        const stepX = w / 1.4; // Смещение для повторов

        for (let i = -18; i <= 18; i++) {
            const y = i * stepY;
            // 3 повторения в строке
            ctx.fillText(text, -stepX, y);
            ctx.fillText(text, 0, y);
            ctx.fillText(text, stepX, y);
        }
        ctx.restore();
    }

    load();
</script>
</body>
</html>
