<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Документы Nest One</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: #fff; font-family: sans-serif; }
        #header { background: #000; padding: 15px; text-align: center; border-bottom: 2px solid #d4af37; position: sticky; top: 0; z-index: 10; font-weight: bold; letter-spacing: 1px; }
        #viewer { display: flex; flex-direction: column; align-items: center; padding: 10px; }
        canvas { max-width: 100%; height: auto; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: #fff; }
        #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #d4af37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #status { color: #aaa; font-size: 14px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="header">ЗАЩИЩЕННЫЙ ПРОСМОТР</div>
<div id="loader"><div class="spinner"></div><div id="status">Загрузка защищенного документа...</div></div>
<div id="viewer"></div>

<script>
    // --- ВСТАВЬТЕ ССЫЛКУ ИЗ DEPLOY НИЖЕ ---
    const API = 'https://script.google.com/macros/s/AKfycbwh9dwQE_8lM3ZYbEEVyo4DwUC3RFdcXTi_tdBhmIjt237exEIiQFzW0uS11OQfzyDW/exec';
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const uid = params.get('id');
    const name = params.get('name') || 'Собственник';
    const room = params.get('room') || 'Не указано';
    const date = params.get('date') || new Date().toLocaleDateString();

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    async function load() {
        if (!fid || !uid) { 
            document.getElementById('status').innerText = 'Ошибка: Неверная ссылка'; 
            document.querySelector('.spinner').style.display = 'none';
            return; 
        }

        try {
            const pdfRes = await fetch(`${API}?action=getPdf&fid=${fid}`);
            const pdfData = await pdfRes.json();

            if (!pdfData.success) throw new Error("Файл не найден");

            // Формируем массив строк для штампа
            const watermarkLines = [
                `${name} (ID: ${uid})`,
                `Помещение: ${room}`,
                `Дата: ${date}`
            ];

            render(pdfData.base64, watermarkLines);

        } catch (e) { 
            document.getElementById('status').innerText = 'Ошибка доступа или загрузки'; 
            document.querySelector('.spinner').style.display = 'none';
            console.error(e);
        }
    }

    async function render(base64, lines) {
        const pdf = await pdfjsLib.getDocument({ data: atob(base64) }).promise;
        document.getElementById('loader').style.display = 'none';

        for (let n = 1; n <= pdf.numPages; n++) {
            const page = await pdf.getPage(n);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            drawWM(canvas, lines);
            document.getElementById('viewer').appendChild(canvas);
        }
    }

    function drawWM(canvas, lines) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
