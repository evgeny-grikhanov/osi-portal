<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–∫—É–º–µ–Ω—Ç—ã Nest One</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>

    <style>
        body { margin: 0; background: #1a1a1a; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        #header { width: 100%; background: #000; padding: 15px 0; border-bottom: 2px solid #d4af37; position: sticky; top: 0; z-index: 100; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
        #title { font-weight: bold; letter-spacing: 1px; margin-right: 20px; }
        .btn { background-color: #333; color: #fff; border: 1px solid #555; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .btn:hover { background-color: #d4af37; color: #000; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #222; color: #777; }
        #viewer { display: flex; flex-direction: column; align-items: center; padding: 20px 10px; width: 100%; max-width: 1000px; }
        canvas { max-width: 100%; height: auto; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: #fff; border-radius: 4px; }
        #loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid #d4af37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        #status { color: #aaa; font-size: 14px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="header">
    <span id="title">–ó–ê–©–ò–©–ï–ù–ù–´–ô –ü–†–û–°–ú–û–¢–†</span>
    <button id="btnDownload" class="btn" onclick="handleAction('download')" disabled>üì• –°–∫–∞—á–∞—Ç—å</button>
    <button id="btnPrint" class="btn" onclick="handleAction('print')" disabled>üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
</div>

<div id="loader">
    <div class="spinner"></div>
    <div id="status">–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞...</div>
</div>

<div id="viewer"></div>

<script>
    // --- –í–°–¢–ê–í–¨–¢–ï –°–°–´–õ–ö–£ –ò–ó DEPLOY –ù–ò–ñ–ï ---
    const API = 'https://script.google.com/macros/s/AKfycbwh9dwQE_8lM3ZYbEEVyo4DwUC3RFdcXTi_tdBhmIjt237exEIiQFzW0uS11OQfzyDW/exec';
    
    const params = new URLSearchParams(window.location.search);
    const fid = params.get('fid');
    const uid = params.get('id');

    let finalPdfBytes = null; // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–µ–∂–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π PDF (–¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É)
    let fileName = `NestOne_Doc_${uid}.pdf`;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä Base64 -> Bytes
    function base64ToUint8Array(base64) {
        const raw = atob(base64.replace(/\s/g, ''));
        const rawLength = raw.length;
        const array = new Uint8Array(rawLength);
        for (let i = 0; i < rawLength; i++) { array[i] = raw.charCodeAt(i); }
        return array;
    }

    async function init() {
        if (!fid || !uid) { showError('–û—à–∏–±–∫–∞ —Å—Å—ã–ª–∫–∏'); return; }

        try {
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –∏ –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞
            const [fileRes, userRes] = await Promise.all([
                fetch(`${API}?action=getPdf&fid=${fid}`),
                fetch(`${API}?action=getUserInfo&id=${uid}`)
            ]);

            const fileJson = await fileRes.json();
            const userJson = await userRes.json();

            if (!fileJson.success) throw new Error("–§–∞–π–ª –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω");

            document.getElementById('status').innerText = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞...';

            // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —à—Ç–∞–º–ø–∞
            const userName = userJson.success ? userJson.name : '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫';
            const userRoom = userJson.success ? userJson.premises : '---';
            const dateStr = new Date().toLocaleDateString('ru-RU');
            const watermarkData = [
                `${userName} (ID: ${uid})`,
                `–ü–æ–º–µ—â–µ–Ω–∏–µ: ${userRoom}`,
                `–î–∞—Ç–∞: ${dateStr}`
            ];

            // 3. –°–æ–∑–¥–∞–µ–º –ï–î–ò–ù–´–ô PDF (–∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –∏–ª–∏ –∏–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏)
            finalPdfBytes = await createProtectedPdf(fileJson, watermarkData);

            // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await renderPreview(finalPdfBytes);

            // 5. –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('btnDownload').disabled = false;
            document.getElementById('btnPrint').disabled = false;

        } catch (e) { showError('–û—à–∏–±–∫–∞: ' + e.message); console.error(e); }
    }

    // –ì–õ–ê–í–ù–ê–Ø –ú–ê–ì–ò–Ø: –°–æ–∑–¥–∞–µ—Ç PDF —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º –∏–∑ —á–µ–≥–æ —É–≥–æ–¥–Ω–æ
    async function createProtectedPdf(fileJson, watermarkLines) {
        const { PDFDocument, rgb, degrees } = PDFLib;
        const fileBytes = base64ToUint8Array(fileJson.base64);
        const mime = fileJson.mimeType || "";

        let pdfDoc;

        // –ê. –ï—Å–ª–∏ —ç—Ç–æ –ö–ê–†–¢–ò–ù–ö–ê -> –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π PDF –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
        if (mime.includes('image')) {
            pdfDoc = await PDFDocument.create();
            const page = pdfDoc.addPage();
            const { width, height } = page.getSize();
            
            let image;
            if (mime.includes('png')) image = await pdfDoc.embedPng(fileBytes);
            else image = await pdfDoc.embedJpg(fileBytes);

            // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –ø–æ —Ä–∞–∑–º–µ—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            const imgDims = image.scaleToFit(width, height);
            
            page.drawImage(image, {
                x: (width / 2) - (imgDims.width / 2),
                y: (height / 2) - (imgDims.height / 2),
                width: imgDims.width,
                height: imgDims.height,
            });
        } 
        // –ë. –ï—Å–ª–∏ —ç—Ç–æ PDF -> –ó–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
        else {
            pdfDoc = await PDFDocument.load(fileBytes);
        }

        // –í. –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏ (–®—Ä–∏—Ñ—Ç Ubuntu –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
        pdfDoc.registerFontkit(fontkit);
        const fontUrl = 'https://pdf-lib.js.org/assets/ubuntu/Ubuntu-R.ttf';
        const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
        const customFont = await pdfDoc.embedFont(fontBytes);

        const pages = pdfDoc.getPages();
        const fontSize = 14;
        const lineHeight = 16;
        const opacity = 0.30;
        const color = rgb(1, 0, 0); // –ö—Ä–∞—Å–Ω—ã–π

        // –†–∞—Å—á–µ—Ç —à–∏—Ä–∏–Ω—ã —à—Ç–∞–º–ø–∞
        let maxW = 0;
        watermarkLines.forEach(l => {
            const w = customFont.widthOfTextAtSize(l, fontSize);
            if(w > maxW) maxW = w;
        });
        
        const stepX = maxW + 80;
        const stepY = (watermarkLines.length * lineHeight) + 60;

        // –†–∏—Å—É–µ–º –Ω–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        pages.forEach(page => {
            const { width, height } = page.getSize();
            const diag = Math.sqrt(width*width + height*height) + 500;

            for (let y = -diag; y < diag; y += stepY) {
                const rowShift = (Math.floor(y/stepY)%2 === 0) ? 0 : stepX/2;
                for (let x = -diag; x < diag; x += stepX) {
                    watermarkLines.forEach((line, i) => {
                        const offset = (i - (watermarkLines.length-1)/2) * lineHeight;
                        page.drawText(line, {
                            x: (width/2) + x + rowShift,
                            y: (height/2) + y - offset,
                            size: fontSize,
                            font: customFont,
                            color: color,
                            opacity: opacity,
                            rotate: degrees(-45),
                        });
                    });
                }
            }
        });

        return await pdfDoc.save();
    }

    async function renderPreview(pdfBytes) {
        document.getElementById('status').innerText = '–†–µ–Ω–¥–µ—Ä–∏–Ω–≥...';
        const pdf = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        document.getElementById('loader').style.display = 'none';

        for (let n = 1; n <= pdf.numPages; n++) {
            const page = await pdf.getPage(n);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height; canvas.width = viewport.width;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            document.getElementById('viewer').appendChild(canvas);
        }
    }

    async function handleAction(type) {
        const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);

        if (type === 'download') {
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
        } else {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = url;
            document.body.appendChild(iframe);
            iframe.onload = function() {
                setTimeout(() => { iframe.contentWindow.print(); }, 500);
            };
        }
    }

    function showError(msg) {
        document.getElementById('status').innerText = msg;
        document.getElementById('status').style.color = '#ff5555';
        document.querySelector('.spinner').style.display = 'none';
    }

    init();
</script>
</body>
</html>
